---
- name: "install nginx"
  become_user: "{{ remote_admin_account }}"
  become: yes
  apt:
    name: "nginx"
    state: present
    # update_cache: yes
    force_apt_get: yes

# Get vmi/.nginx/{{ role_type }}/nginx.conf out of repo
# pull to tmp and use as template source to push to /etc/nginx/nginx.conf
- name: "get  vmi/.nginx/{{ role_type }}/nginx.conf out of repo"
  become_user: "{{ remote_admin_account }}"
  become: yes
  run_once: true
  fetch:
    src: "{{ base_app_directory }}/{{ role_type }}/.nginx/template/{{ item }}"
    dest: "/tmp/{{ item }}"
    flat: yes
    fail_on_missing: yes
  with_items:
    - nginx.conf
    - uwsgi.ini

- name: "copy nginx.conf from vmi/.nginx to the target"
  become_user: "{{ remote_admin_account }}"
  become: yes
  template:
    src: /tmp/nginx.conf
    dest: /etc/nginx/nginx.conf
    mode: 0644

- name: "remove default config files"
  become_user: "{{ remote_admin_account }}"
  become:
  file:
    path: "/etc/nginx/conf.d/default.conf"
    state: absent

- name: "create group logreader"
  become_user: "{{ remote_admin_account }}"
  become: yes
  group:
    name: logreader
    system: yes
    state: present

- name: "set permission on nginx log dir"
  become: yes
  become_user: "{{ remote_admin_account }}"
  file:
    path: /var/log/nginx
    state: directory
    mode: 0755
    group: "logreader"

- name: "install uwsgi"
  become: yes
  become_user: "{{ remote_admin_account }}"
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - uwsgi
#
- name: "create sock path"
  become_user: "{{ remote_admin_account }}"
  become: yes
  file:
    path: "/var/pyapps/{{ role_type }}"
    state: directory
    mode: "0664"

- name: "create sock file"
  become_user: "{{ remote_admin_account }}"
  become: yes
  file:
    path: "/var/pyapps/{{ role_type }}/pyapps.sock"
    state: touch
    mode: "0664"

- name: "create vassals dir"
  become_user: "{{ remote_admin_account }}"
  become: yes
  file:
    path: /etc/uwsgi/vassals
    state: directory
    mode: "0664"

- name: "install uwsgi ini file from copied template file"
  become_user: "{{ remote_admin_account }}"
  become: yes
  template:
    src: /tmp/uwsgi.ini
    dest: /etc/uwsgi/vassals/uwsgi.ini
    mode: "0644"

- name: "add uwsgi to system startup"
  become_user: "{{ remote_admin_account }}"
  become: yes
  template:
    src: files/uwsgi.service
    dest: /etc/systemd/system/uwsgi.service
    mode: "0644"
#
- name: "enable nginx"
  become_user: "{{ remote_admin_account }}"
  become: yes
  service:
    name: nginx
    enabled: yes

- name: "enable uwsgi"
  become_user: "{{ remote_admin_account }}"
  become: yes
  service:
    name: uwsgi
    enabled: yes

- name: "install supervisor"
  become_user: "{{ remote_admin_account }}"
  become: yes
  apt:
    name: supervisor
    state: present


